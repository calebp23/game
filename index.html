<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unique Random 30–200 — Vanilla</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { --bg: #fafafa; --fg: #0a0a0a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb; --accent:#18181b; }
    .dark { --bg:#0a0a0a; --fg:#fafafa; --muted:#d1d5db; --card:#111113; --border:#27272a; --accent:#fafafa; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    .row { display:flex; justify-content:space-between; align-items:center; gap: 12px; }
    .h1 { font-weight:800; font-size: clamp(22px, 3vw, 30px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; }
    .btn { border:1px solid var(--border); background:transparent; color:var(--fg); padding:8px 12px; border-radius:14px; cursor:pointer; }
    .btn[disabled] { opacity:.4; cursor:not-allowed; }
    .btn:hover { box-shadow:0 1px 8px rgba(0,0,0,.05); }
    .pill { border:1px solid var(--border); background:#f8fafc; color:#111; padding:6px 10px; border-radius:999px; font-size:13px; }
    .dark .pill { background:#0f172a; color:#e5e7eb; }
    .grid { display:grid; gap:12px; }
    .center { display:grid; place-items:center; }
    .big { font-weight:900; font-size: clamp(48px, 10vw, 82px); letter-spacing:-1px; }
    .muted { color:var(--muted); }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { border:1px solid var(--border); background:#f4f4f5; padding:6px 10px; border-radius:12px; font-size:13px; }
    .dark .chip { background:#18181b; color:#e5e7eb; }
    .chip.scored { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .dark .chip.scored { background:rgba(16,185,129,.15); border-color:#065f46; color:#34d399; }
    .scorebtns { display:flex; gap:8px; justify-content:center; }
    .scorebtn { width:44px; height:44px; border-radius:10px; border:1px solid var(--border); background:var(--card); font-weight:700; }
    .scorebtn.active { background:var(--accent); color:var(--bg); }
    canvas { width:100%; height:320px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    footer { text-align:center; font-size:12px; color:var(--muted); margin-top:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div id="app" class="wrap">
    <div class="row">
      <div class="h1">Unique Random (30–200, step 10)</div>
      <div class="row" style="gap:8px">
        <button id="theme" class="btn" aria-label="Toggle dark mode">Dark</button>
        <span class="pill">Remaining: <span id="remain">18</span> / 18</span>
        <span class="pill">Scored: <span id="scored">0</span></span>
        <span class="pill">Avg: <span id="avg">—</span></span>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card center">
        <div class="muted" style="text-transform:uppercase; letter-spacing:.12em; font-size:12px;">Current Draw</div>
        <div id="current" class="big" style="margin:10px 0">—</div>
        <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:center">
          <button id="draw" class="btn">Draw a Number</button>
          <button id="reset" class="btn">Reset</button>
          <button id="undo" class="btn" disabled>Undo last score</button>
        </div>

        <div id="scoreArea" style="margin-top:14px; width:100%; display:none">
          <div class="center muted" style="font-size:14px; margin-bottom:6px">Tap a score for <span id="currLabel" style="font-weight:600"></span> (1–5)</div>
          <div class="scorebtns">
            <button class="scorebtn" data-v="1">1</button>
            <button class="scorebtn" data-v="2">2</button>
            <button class="scorebtn" data-v="3">3</button>
            <button class="scorebtn" data-v="4">4</button>
            <button class="scorebtn" data-v="5">5</button>
          </div>
          <div id="saveMsg" class="center" style="font-size:12px; color:#059669; margin-top:6px; display:none"></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div style="font-weight:600; margin-bottom:8px">Already Drawn</div>
          <div id="drawnChips" class="chips muted"></div>
        </div>
        <div class="card">
          <div style="font-weight:600; margin-bottom:8px">Still Available</div>
          <div id="availChips" class="chips muted"></div>
        </div>
      </div>

      <div id="finalCard" class="card" style="display:none">
        <div style="font-weight:700; font-size:20px; margin-bottom:8px; text-align:center">All Numbers Drawn</div>
        <div id="finalAvg" class="big" style="text-align:center; margin-bottom:6px">0.00</div>
        <div class="muted" style="text-align:center; margin-bottom:12px">Average score across <span id="finalCount">0</span> items · Total: <span id="finalTotal">0</span></div>
        <canvas id="chart" width="900" height="320" aria-label="Distance vs Shots chart"></canvas>
        <div id="notAll" class="muted" style="text-align:center; font-size:12px; margin-top:8px; display:none">You haven't scored all items yet.</div>
      </div>
    </div>

    <footer>Tip: The pool is 30, 40, 50, …, 200</footer>
  </div>

<script>
(function(){
  // --- State ---
  let available = [];
  let drawn = [];
  let current = null;
  let scores = {};        // distance -> 1..5
  let scoredOrder = [];   // order of numbers as they're scored
  let dark = false;
  let finishedOnce = false;

  // --- Elements ---
  const elRemain = document.getElementById('remain');
  const elScored = document.getElementById('scored');
  const elAvg = document.getElementById('avg');
  const elCurrent = document.getElementById('current');
  const elCurrLabel = document.getElementById('currLabel');
  const elDraw = document.getElementById('draw');
  const elReset = document.getElementById('reset');
  const elUndo = document.getElementById('undo');
  const elScoreArea = document.getElementById('scoreArea');
  const elSaveMsg = document.getElementById('saveMsg');
  const elDrawnChips = document.getElementById('drawnChips');
  const elAvailChips = document.getElementById('availChips');
  const elFinal = document.getElementById('finalCard');
  const elFinalAvg = document.getElementById('finalAvg');
  const elFinalCount = document.getElementById('finalCount');
  const elFinalTotal = document.getElementById('finalTotal');
  const elNotAll = document.getElementById('notAll');
  const elTheme = document.getElementById('theme');
  const chart = document.getElementById('chart');
  const ctx = chart.getContext('2d');

  // --- Helpers ---
  function makePool(){ const a=[]; for(let n=30;n<=200;n+=10)a.push(n); return a; }
  function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
  function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi, v)); }
  function canDrawNext(){ return current===null || (current!==null && typeof scores[current]==='number'); }

  function render() {
    // header stats
    elRemain.textContent = String(available.length);
    const scoredEntries = Object.entries(scores);
    const scoredCount = scoredEntries.length;
    const scoreSum = scoredEntries.reduce((a,[,v])=>a+v,0);
    const avg = scoredCount ? (scoreSum/scoredCount) : null;
    elScored.textContent = String(scoredCount);
    elAvg.textContent = avg===null ? '—' : (avg.toFixed(2));

    // current
    elCurrent.textContent = (current===null ? '—' : String(current));
    elCurrLabel.textContent = (current===null ? '' : String(current));
    elScoreArea.style.display = (current===null ? 'none' : 'block');
    elDraw.disabled = (available.length===0) || !canDrawNext();
    elUndo.disabled = (scoredOrder.length===0);

    // chips
    elDrawnChips.innerHTML = '';
    drawn.forEach(n=>{
      const s = scores[n];
      const span = document.createElement('span');
      span.className = 'chip' + (typeof s==='number' ? ' scored' : '');
      span.textContent = typeof s==='number' ? `${n} · ${s}/5` : String(n);
      elDrawnChips.appendChild(span);
    });
    elAvailChips.innerHTML = '';
    const sortedAvail = [...available].sort((a,b)=>a-b);
    sortedAvail.forEach(n=>{
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = String(n);
      elAvailChips.appendChild(span);
    });

    // final card + chart when all drawn
    const allDone = available.length===0;
    elFinal.style.display = allDone ? 'block' : 'none';
    if (allDone) {
      elFinalAvg.textContent = (avg===null ? '0.00' : avg.toFixed(2));
      elFinalCount.textContent = String(scoredCount);
      elFinalTotal.textContent = String(scoreSum);
      elNotAll.style.display = (scoredCount!==18 ? 'block' : 'none');

      // chart data: include ALL drawn; unscored -> 0
      const data = [...drawn].sort((a,b)=>a-b).map(d => ({distance:d, shots: (typeof scores[d]==='number' ? scores[d] : 0)}));
      drawChart(ctx, data, avg||0);
      if (!finishedOnce && scoredCount>0) {
        finishedOnce = true;
        if (window.confetti) {
          window.confetti({ particleCount: 160, spread: 70, origin: { y: 0.6 } });
          setTimeout(()=>window.confetti({ particleCount: 120, spread: 90, origin: { y: 0.7 } }), 400);
        }
      }
    }
  }

  function drawChart(ctx, data, avg) {
    // clear
    ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
    // padding
    const P = { l:40, r:10, t:10, b:28 };
    const W = ctx.canvas.width - P.l - P.r;
    const H = ctx.canvas.height - P.t - P.b;
    // axes
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border');
    ctx.beginPath();
    ctx.moveTo(P.l, P.t);
    ctx.lineTo(P.l, P.t+H);
    ctx.lineTo(P.l+W, P.t+H);
    ctx.stroke();

    // y ticks 0..5
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for (let yv=0; yv<=5; yv++) {
      const y = P.t + H - (yv/5)*H;
      ctx.fillText(String(yv), P.l-6, y);
      ctx.strokeStyle = 'rgba(0,0,0,0.05)';
      ctx.beginPath(); ctx.moveTo(P.l, y); ctx.lineTo(P.l+W, y); ctx.stroke();
    }

    if (!data.length) return;
    // bars
    const n = data.length;
    const gap = 6;
    const barW = Math.max(2, (W - gap*(n-1)) / n);
    ctx.textAlign = 'center'; ctx.textBaseline = 'top';

    data.forEach((d, i) => {
      const x = P.l + i*(barW+gap);
      const h = Math.max(0, Math.min(1, d.shots/5)) * H;
      const y = P.t + H - h;

      ctx.fillStyle = '#3b82f6'; // blue
      ctx.fillRect(x, y, barW, h);

      // x labels (distance)
      if (n <= 24 || i % 2 === 0) {
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
        ctx.fillText(String(d.distance), x + barW/2, P.t+H+4);
      }
    });

    // average line
    const yAvg = P.t + H - (avg/5)*H;
    ctx.strokeStyle = '#6b7280';
    ctx.setLineDash([5,4]);
    ctx.beginPath(); ctx.moveTo(P.l, yAvg); ctx.lineTo(P.l+W, yAvg); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg');
    ctx.fillText(`Avg ${avg.toFixed(2)}`, P.l+W-40, yAvg-10);
  }

  // --- Actions ---
  function doDraw(){
    if (available.length===0 || !canDrawNext()) return;
    const idx = Math.floor(Math.random()*available.length);
    const next = available[idx];
    available.splice(idx,1);
    drawn.unshift(next);
    current = next;
    render();
  }
  function doReset(){
    available = shuffle(makePool());
    drawn = [];
    current = null;
    scores = {};
    scoredOrder = [];
    finishedOnce = false;
    render();
  }
  function doSetScore(val){
    if (current===null) return;
    const v = clamp(Number(val),1,5);
    const already = typeof scores[current]==='number';
    scores[current] = v;
    if (!already) scoredOrder.push(current);
    elSaveMsg.textContent = `Saved score ${v} for ${current}.`;
    elSaveMsg.style.display = 'block';
    setTimeout(()=>{ elSaveMsg.style.display = 'none'; }, 900);
    render();
  }
  function doUndo(){
    if (!scoredOrder.length) return;
    const last = scoredOrder.pop();
    delete scores[last];
    current = last; // allow re-score
    render();
  }

  // --- Init ---
  doReset();
  elDraw.onclick = doDraw;
  elReset.onclick = doReset;
  elUndo.onclick = doUndo;
  document.querySelectorAll('.scorebtn').forEach(btn=>{
    btn.addEventListener('click', ()=> doSetScore(btn.getAttribute('data-v')));
  });
  elTheme.onclick = () => {
    dark = !dark;
    document.documentElement.classList.toggle('dark', dark);
    elTheme.textContent = dark ? 'Light' : 'Dark';
    render(); // redraw chart in theme
  };

  // --- Minimal tests ---
  (function tests(){
    const a = [30,40,50]; const b = shuffle(a);
    console.assert(b.length===3, '[t] shuffle length');
    console.assert(new Set(b).size===3, '[t] shuffle unique');
    console.assert(clamp(0,1,5)===1 && clamp(9,1,5)===5, '[t] clamp');
  })();
})();</script>
</body>
</html>
